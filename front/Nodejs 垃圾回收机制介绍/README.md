# Nodejs 垃圾回收机制介绍

> 过年在家拜读了一下 [深入浅出Node.js], 颇有收获, 分享一下其中内存管理章节.

## 一. 内存管理方案

> 各种编程语言内存管理的方式介绍
    
    现在主流编程内存管理方式如下, 可以看到大部分语言都是采用的 GC 垃圾回收机制.

    - C: 纯手工管理内存
    - C++:  手工管理 + 确定性析构 (RAII)
    - GC 语言(包括 java, go, javascript, python 等):  GC 自动垃圾回收
    - Rust: 借鉴 C++ 的 RAII 的所有权机制

> RAII，全称资源获取即初始化（英语：Resource Acquisition Is Initialization. RAII要求，资源的有效期与持有资源的对象的生命期严格绑定，即由对象的构造函数完成资源的分配（获取），同时由析构函数完成资源的释放。在这种要求下，只要对象能正确地析构，就不会出现资源泄露问题。

    我们知道, 比如C、C++, 语言默认不管理内存, 他们提供 malloc、realloc、calloc 和 free等 , 基本上依赖程序员手动管理, 一方面来说加大了程序员的心智负担 (程序员头顶的达摩克利斯之剑), 而且非常依赖于程序员本身水平, 一方面完全依靠人力, 非常容易出现内存泄漏, 悬垂指针, 引用未初始化内存等问题. 但其好处是运行速度快, 没有运行时开销. C/C++ 功不可没地构建了操作系统内核, 为上层应用搭建基础.

    由于上述原因, 出现了自带 GC 的语言, 现在几乎主流编程语言有 GC 的功能. 其时代背景是 90 年代以来, 全世界对程序的需求越来越大, 此时编程语言的瓶颈不再是运行速度, 而是开发速度, 以至于又出现了解释型编程语言, 程序员不再需要手动内存管理, 极大的降低了编程门槛, 提高的程序员的生产力. 当然这些好处有代价的. GC 增加了运行时开销, 也带来了 "stop the world".

    其中, 年轻的 Rust 语言吸收力借鉴了两种方式的优缺点, 使用所有权机制管理内存, 既不用手动管理, 也无需引入 GC, 以内存安全著称. 这里不做重点, 有兴趣的同学自己了解一下吧.


## 二. 栈和堆
> 深入的了解编程语言内部机制, 总是绕不过栈和堆

 1. 栈(stack)

 顾名思义，是一种先进后出的结构，参考一下餐盘的取和放
 ### 栈的特点

    - 由于先进后出性质，在数据的处理上栈有着很好的速度，因为只需从最顶部压栈和出栈就好了，简单明了。
    -  不过，存储在栈中的数据必须是大小有限，生存期确定。
    -  函数执行的时候会创建一个明确的栈，并压入，而当执行期间会存储函数内的所有数据，这就是栈帧。个人感觉可以理解为当前执行函数的快照。
    -  多线程应用程序有多个栈。
    -  栈的操作系统自动分配或释放。
    -  存储在栈中的常见类型有：局部变量(值类型、基本类型、常量)、指针和函数
    -  还记得平常偶尔遇到的 stack overflow error 吗？这是因为与堆相比，栈的大小受到了限制。大多属语言都是都是这样。
    
> 调用堆栈示例 ![调用堆栈示例](https://user-gold-cdn.xitu.io/2020/2/4/1700e60b3cadfa55?w=1179&h=693&f=gif&s=177834)


 2. 堆(heap)

堆常用来动态内存分配，程序在堆中寻找数据需要使用指针。
### 堆的特点

    - 效率不如栈，但是可以存储更多的数据
    - 可存储大小不确定的数据，如运行时确定
    - 应用程序中多线程共享堆数据
    - 堆由人工操作，故管理起来很棘手，可能会引起内存泄漏等问题，所以有很多语言有gc机制
    - 存储在堆中的常见类型有：全局变量、引用类型和其他复杂的数据结构
    - 这就是为什么你会遇到 out of memory errors 这类问题，因为用户的胡乱分配或者未销毁
    - 我们分配给堆的数据其实并没有大小限制，理论上来说你可以分配无穷大的数据。当然如果这样你也得为应用程序分配这么多的内存。 -_-


### 内存堆栈 与 数据结构堆栈的区别

 -  | 内存 | 内存 | 
- | :-: | :-: | 
堆	| new一个对象的引用或地址存储在栈区，指向该对象存储在堆区中的真实数据。由程序员分配和回收	|是一棵完全二叉树结构 |
栈	| 存储运行方法的形参、局部变量、返回值。由系统自动分配和回收。|	是一种连续存储的数据结构，特点是存储的数据先进后出|

    | 内存 |	内存
    -|-|-
堆	| new一个对象的引用或地址存储在栈区，指向该对象存储在堆区中的真实数据。由程序员分配和回收	|是一棵完全二叉树结构
栈	| 存储运行方法的形参、局部变量、返回值。由系统自动分配和回收。|	是一种连续存储的数据结构，特点是存储的数据先进后出


**由于栈是由系统分配和回收, 所以我们接下来讨论的自动内存管理主要是堆.**

## 三. Node 与 V8



> 参考
 ![深入浅出Node.js](https://img9.doubanio.com/view/subject/l/public/s27134708.jpg)
